---
title: 'W271 Live Session 13: Analysis of Panel Data 2'
author: "Professor Jeffrey Yau"
date: "Spring 2019"
output:
  html_notebook: default
---

# Main topics covered in Week 12
    - Fixed Effect Model
    - A Digression: differencing when there are more than 2 time periods
    - Random effect model
    - Fixed effect vs. random effect models

# Readings
**W2016:** Jeffrey Wooldridge. *Introductory Econometrics: A Modern Approach.* 6th edition. Cengage Learning 

    - Ch. 14.1 - 14.2
    - [package plm](https://cran.r-project.org/web/packages/plm/plm.pdf)
    - [plm vignettes](https://cran.r-project.org/web/packages/plm/vignettes/plm.pdf)

# Agenda for this week's live session:

  1. Discussion of Task 3 from Week 11's live session

  2. An Example

# Recap:

Remember that the observations in our (cross-section) linear regression models covered in w203 and discrete-response models covered in lecture 1 - 5 assume that observations are independent of each other.  This is, nevertheless, is a very strong assumption and often does not hold in practice. Unfortunately, many practitioners still simply apply linear regression models to data whose observations are dependent due to temporal or spatial dependence. Studies collecting measures over time clearly cannot use the independence assumption.

Some start-up codes:
```{r, messages=FALSE}
#sessionInfo()

# Insert the function to *tidy up* the code when they are printed out
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)

# Clean up the workspace before we begin
rm(list = ls())

# Set working directory
#wd <- "~/Documents/Teach/Cal/w271/_2018.03_Fall/live-session-files/week11"
#setwd(wd)


# Load libraries
library(car)
library(dplyr)
library(Hmisc)
library(ggplot2)
library(lattice)
library(plm)
```

# An Example

## Exploratory Data Analysis

In this example, we use a modified panel dataset on 7 countries. The *yIndex* is a measure of the well-being of the population in a country, considering that as some health measure. A bigger number reflects a better health status. The *xIndex* variable is a (normalized) measure of the economic activities of the country; a bigger number indiciates "better" economic performance. *country* indicates, well, country, and *year* indicates the year in which the health and economic measurements were taken. The question of interest is "Does better economic activities, as measured by *xIndex*, improve the country's health status, as measured by *yIndex*?"

**Tasks:** 
    - Import the data as data.frame. 
    - Examine the basic structure of each of the datasets. 
    - Try to understand each of the variables
    - Discuss about the dataset
    - At what level is this dataset?
    - Conduct a throughout EDA, including a growth curve analysis that was covered in the live session in week 12
    
```{r}
library(foreign)
#library(gplots)
library(ggplot2)
library(stats)
library(Hmisc)
library(car)

# Import the data
df <- read.csv("data_wk12.csv", sep=",", header=T)

str(df)
describe(df)
table(df$year)
table(df$country)
table(df$year, df$country)
  
round(cor(df[ ,4:5]),3)

# Density
density_plot = function(data, plotvar, title) {
  ggplot(data, aes(plotvar)) + geom_density() + ggtitle(title)
}
density_plot(df, df$yIndex, "yIndex")
density_plot(df, df$yIndex, "xIndex")

# Conditional Box-plot
conditional_plot = function(data, plotvar, condvar, title) {
  g <- ggplot(data, aes(as.factor(condvar), plotvar)) 
  g + geom_boxplot() + geom_jitter(width = 0.2) + ggtitle(title)
}

# yIndex by year (Heterogeineity across year)
conditional_plot(df, df$yIndex, df$year, "yIndex by year")

# yIndex by country (Heterogeineity across countries)
conditional_plot(df, df$yIndex, df$country, "yIndex by country")

# xIndex by year
conditional_plot(df, df$xIndex, df$year, "xIndex by year")

# xIndex by country
conditional_plot(df, df$xIndex, df$country, "xIndex by country")

scatterplot(yIndex ~  year|country, boxplots=FALSE, smooth=TRUE, data=df)

# Heterogeineity across countries
plotmeans(yIndex ~ country, main="Heterogeineity across countries", data=df)
plotmeans(yIndex ~ year, main="Heterogeineity across years", data=df)

# 
coplot(yIndex ~ year|country, type="l", data=df)
coplot(xIndex ~ year|country, type="b", data=df)

plotmeans(yIndex ~ country, main="Heterogeineity across countries", data=df)

xyplot(yIndex ~ year | country, data=df, as.table=T)
xyplot(xIndex ~ year | country, data=df, as.table=T)
xyplot(yIndex ~ xIndex | country, data=df, as.table=T)

```


## OLS Regression Models

**Tasks:** 
  - Suppose you want to answer the question posted above using an OLS regression model.
  - Is OLS regression model a reasonable approach? Why? Why not?
  - Don't forget to interpret the result! So, according to your model, what's your answer to the question posted above?
  - What do you have to assume to make this approach reasonable?
  - Are these assumptions that you will have to make valid?

Remember that there are different ways OLS regressions can be applied.  One way is pooled-OLS.  


```{r}
m1.ols <-lm(yIndex ~ xIndex, data=df)
  summary(m1.ols)
  plot(m1.ols)
  #residualPlot(m1.ols)

#Regular OLS regression does not consider heterogeneity across groups or time 
plot(df$xIndex, df$yIndex, pch=19, xlab="xIndex", ylab="yIndEx")
abline(lm(df$yIndex ~ df$xIndex),lwd=3, col="red")

```

## Fixed-Effect Regression Model

**Tasks:**
  - Suppose you want to answer the question posted above using a Fixed-Effect regression model.
  - First, write done a fixed-effect regression model with an unobserved effect.
  - What assumptions are needed for the fixed-effect regression model?
  - Explain what a fixed effect is?
  - Think about why a fixed-effect framework would make sense for this question?
  - Estimate a fixed-effect model.
  - In your fixed-effect model, how many groups, time periods, and observations are there?
  - Don't forget to interpret the result! So, according to your model, what's your answer to the question posted above?

```{r}
library(plm)

model.fe.dum <-lm(yIndex ~ xIndex + factor(country)-1, data=df)
  summary(model.fe.dum)
  yhat <- model.fe.dum$fitted

model.fe<-plm(yIndex ~ xIndex, data=df, index=c("country", "year"), model="within")
summary(model.fe)

scatterplot(yhat ~ df$xIndex | df$country, boxplots=FALSE, xlab="xIndex", ylab="yhat",smooth=FALSE)
abline(lm(df$yIndex ~ df$xIndex),lwd=3, col="blue")
```

## Random-Effect Regression Model

**Tasks:**
  - Suppose you want to answer the question posted above using a Random-Effect regression model.
  - First, write done a random-effect regression model with an unobserved effect.
  - What assumptions are needed for the random-effect regression model?
  - Explain what a random effect is?
  - Think about why a random-effect framework would make sense for this question?
  - Estimate a fixed-effect model.
  - Don't forget to interpret the result! So, according to your model, what's your answer to the question posted above?


```{r}
library(plm)
model.re<-plm(yIndex ~ xIndex, data=df, index=c("country", "year"), model="random")
summary(model.re)
```

## Diagnostic Tests and Final Discussion

**Tasks:**
  - Conduct diagnostic tests to determine whether or not a fixed effects model or a random effects model is appropriate.
  - Discuss situations (and assumptions) under which fixed effect is more appropriate and situations under

  - Hausman test: null hypothesis is that the preferred model is random effects vs. the alternative the fixed effects. It tests whether the unique errors $u_i$ are correlated with the explanatory variables; the null hypothesis is they are not.
    - Estimate a fixed effects model and a random effect model. Then perform the test. If the p-value is significant (e.g. $p \leq 0.05$), then use fixed effects; otherwise, use random effects.

```{r}
phtest(model.fe, model.re)
```

# Your Turn - Let's replicate and extend an example in Wooldridge


```{r}
load("wagepan.RData")
self
desc
wagepan = data
str(wagepan)
describe(wagepan)
head(data)
```